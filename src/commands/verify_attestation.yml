description: Verifies an attestation attached to a container image. Supports public key and keyless verification.
parameters:
  image:
    type: string
    description: Container image to verify the attestation for.
  predicate_type:
    type: string
    description: The predicate type. Common types are spdx, spdxjson, cyclonedx, and vuln.
  keyless:
    type: boolean
    description: |
      Use keyless verification. When enabled, verifies using certificate identity and OIDC issuer
      instead of a public key. In CircleCI environments, verification parameters are auto-detected
      from CIRCLE_ORGANIZATION_ID and CIRCLE_PROJECT_ID if not explicitly provided.
    default: false
  public_key:
    type: env_var_name
    description: Environment variable that holds the base-64 encoded public key. Ignored when keyless is true.
    default: COSIGN_PUBLIC_KEY
  certificate_identity:
    type: string
    description: |
      Expected identity in the Fulcio certificate (keyless only).
      For CircleCI, this is the certificate subject URL.
      Example: "https://circleci.com/api/v2/projects/<project-id>/pipeline-definitions/<pipeline-def-id>"
      If not provided, auto-detected from CIRCLE_PROJECT_ID (uses regexp matching).
    default: ""
  certificate_identity_regexp:
    type: string
    description: |
      Regular expression to match certificate identity (keyless only).
      Example: "https://circleci.com/api/v2/projects/<project-id>/pipeline-definitions/.*"
      If not provided (and certificate_identity is empty), auto-generated from CIRCLE_PROJECT_ID.
    default: ""
  certificate_oidc_issuer:
    type: string
    description: |
      Expected OIDC issuer in the Fulcio certificate (keyless only).
      For CircleCI: "https://oidc.circleci.com/org/<org-id>"
      If not provided, auto-detected from CIRCLE_ORGANIZATION_ID.
    default: ""
  certificate_oidc_issuer_regexp:
    type: string
    description: |
      Regular expression to match OIDC issuer (keyless only).
      Example: "https://oidc.circleci.com/org/.*"
    default: ""
steps:
  - run:
      name: Verify Attestation
      environment:
        PARAM_IMAGE: << parameters.image >>
        PARAM_PREDICATE_TYPE: << parameters.predicate_type >>
        PARAM_KEYLESS: << parameters.keyless >>
        PARAM_PUBLIC_KEY: << parameters.public_key >>
        PARAM_CERTIFICATE_IDENTITY: << parameters.certificate_identity >>
        PARAM_CERTIFICATE_IDENTITY_REGEXP: << parameters.certificate_identity_regexp >>
        PARAM_CERTIFICATE_OIDC_ISSUER: << parameters.certificate_oidc_issuer >>
        PARAM_CERTIFICATE_OIDC_ISSUER_REGEXP: << parameters.certificate_oidc_issuer_regexp >>
      command: << include(scripts/verify_attestation.sh) >>
